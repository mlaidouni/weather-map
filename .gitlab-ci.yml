image: node:20-alpine

stages:
  - build
  - deploy

# Build Front
build_front:
  stage: build
  script:
    - cd frontend
    - npm install
    - npm run build
  tags:
    - weather-ci
  artifacts:
    paths:
      - frontend/build/
    expire_in: 10 minutes

# Build Back
build_back:
  stage: build
  script:
    - cd backend
    - npm install
    - npm run build
  tags:
    - weather-ci
  artifacts:
    paths:
      - backend/dist/
    expire_in: 10 minutes

# Deploy (les deux)
deploy:
  stage: deploy
  image: docker:24.0.5
  script:
    # FRONT
    - cd frontend
    - docker build -t weathermap-frontend .
    - docker stop weathermap-frontend || true
    - docker rm weathermap-frontend || true
    - docker run -d --name weathermap-frontend -p 3000:3000 --restart unless-stopped weathermap-frontend

    # BACK
    - cd ../backend
    - docker build -t weathermap-backend .
    - docker stop weathermap-backend || true
    - docker rm weathermap-backend || true
    - docker run -d --name weathermap-backend -p 8080:8080 --restart unless-stopped weathermap-backend
  tags:
    - weather-ci
  needs:
    - build_front
    - build_back
